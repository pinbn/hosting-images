user www-data;
worker_processes 8;
pid /run/nginx.pid;

events {
        worker_connections 8096;
        multi_accept on;
        use epoll;
}

worker_rlimit_nofile 40000;

http {
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        types_hash_max_size 2048;
        server_tokens off;
        proxy_intercept_errors on;

        server_names_hash_bucket_size 64;
        server_names_hash_max_size 4112;
        server_name_in_redirect off;

        set_real_ip_from 0.0.0.0/32; # all addresses get a real IP.
        real_ip_header X-Forwarded-For; # the ip is forwarded from the load balancer/proxy

        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        log_format pin_format '$remote_addr - $remote_user [$time_local] "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent" "$http_x_forwarded_for" <msec=$msec|connection=$connection|connection_requests=$connection_requests|http_host=$http_host|pit_cookie=$cookie_pit_cookie|upstream_time=$upstream_response_time|ssl_info=$ssl_protocol/$ssl_cipher|upstream_ssl_info=$http_origssl|upstream_host=$upstream_addr|x-real-ip=$http_x_real_ip|x-forwarded-host=$http_x_forwarded_host|millis=$request_time>';

        access_log /var/log/nginx/access.log pin_format;
        error_log /var/log/nginx/access.log;

        gzip on;
        gzip_disable "msie6";
        gzip_min_length 500;
        gzip_vary on;
        gzip_proxied any;
        gzip_comp_level 6;
        gzip_buffers 16 8k;
        gzip_http_version 1.0;
        gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript application/x-javascript;

  # site
  server {
	  server_name _;
    listen 80 default_server;

	  root /var/www/html;
	  access_log /dev/stdout pin_format;
	  error_log /dev/stderr;

	  index index.php index.html;

	  location / {
		  limit_except GET POST OPTIONS HEAD { deny all; }
		  try_files $uri $uri/ @extphp;
	  }

	  location @extphp {
		  rewrite ^(.*)$ $1.php last;
	  }

    location /logs/ { return 403; }
    location /log/ { return 403; }
    location /.well-known/acme-challenge { root /var/www/html; }

	  location ~ \.php$ {
		  try_files $uri =404;

      proxy_intercept_errors on;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_hide_header Referrer-Policy;
      add_header Referrer-Policy unsafe-url;
      
      proxy_hide_header 'X-Permitted-Cross-Domain-Policies';
      add_header 'X-Permitted-Cross-Domain-Policies' 'master-only';

      fastcgi_hide_header 'X-Powered-By';
      proxy_hide_header 'X-Powered-By';
      add_header 'X-Powered-By' 'Nope/1.0';

      proxy_hide_header 'X-Content-Type-Options';
      add_header 'X-Content-Type-Options' 'nosniff';

      # Not messing with X-Frame-Options
      # Not messing with CORS in hosted sites

      proxy_hide_header X-XSS-Protection;
      add_header 'X-XSS-Protection' '1; mode=block';

      proxy_hide_header Strict-Transport-Security;
      add_header Strict-Transport-Security max-age=31536000;

		  fastcgi_param SSL_INFO $ssl_protocol/$ssl_cipher;
      # httpoxy fix
      fastcgi_param HTTP_PROXY "";

      fastcgi_param  SCRIPT_FILENAME    $document_root$fastcgi_script_name;
      fastcgi_param  QUERY_STRING       $query_string;
      fastcgi_param  REQUEST_METHOD     $request_method;
      fastcgi_param  CONTENT_TYPE       $content_type;
      fastcgi_param  CONTENT_LENGTH     $content_length;

      fastcgi_param  SCRIPT_NAME        $fastcgi_script_name;
      fastcgi_param  REQUEST_URI        $request_uri;
      fastcgi_param  DOCUMENT_URI       $document_uri;
      fastcgi_param  DOCUMENT_ROOT      $document_root;
      fastcgi_param  SERVER_PROTOCOL    $server_protocol;
      fastcgi_param  HTTPS              $https if_not_empty;

      fastcgi_param  GATEWAY_INTERFACE  CGI/1.1;
      fastcgi_param  SERVER_SOFTWARE    nginx/$nginx_version;

      fastcgi_param  REMOTE_ADDR        $remote_addr;
      fastcgi_param  REMOTE_PORT        $remote_port;
      fastcgi_param  SERVER_ADDR        $server_addr;
      fastcgi_param  SERVER_PORT        $server_port;
      fastcgi_param  SERVER_NAME        $server_name;

      # PHP only, required if PHP was built with --enable-force-cgi-redirect
      fastcgi_param  REDIRECT_STATUS    200;

		  fastcgi_index index.php;
		  fastcgi_pass  unix:/var/run/php-fpm.sock;
		  fastcgi_read_timeout 300;
	  }

    location /noop { return 204; access_log off; log_not_found off; }
	  
	  location ~* \.(css|js|ogg|ogv|svg|svgz|eot|otf|woff|mp4|ttf|rss|atom|jpg|jpeg|gif|png|ico|zip|tgz|gz|rar|bz2|doc|xls|exe|ppt|tar|mid|midi|wav|bmp|rtf|swf)$ {
		  access_log off;
		  log_not_found off;
		  expires 7d;
		  add_header Pragma public;
		  add_header Cache-Control "public";
		  add_header Access-Control-Allow-Origin "*";
	  }
  }
}
